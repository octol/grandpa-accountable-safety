<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Implementation - Accountable Safety for GRANDPA</title>
        
        


        <!-- Custom HTML head -->
        


        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        
        <link rel="icon" href="favicon.svg">
        
        
        <link rel="shortcut icon" href="favicon.png">
        
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        
        <link rel="stylesheet" href="css/print.css" media="print">
        

        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        
        <link rel="stylesheet" href="fonts/fonts.css">
        

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        

        
        <!-- MathJax -->
        <script async type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
        
    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded "><a href="intro.html"><strong aria-hidden="true">1.</strong> Introduction</a></li><li class="chapter-item expanded "><a href="outline.html"><strong aria-hidden="true">2.</strong> Outline</a></li><li class="chapter-item expanded "><a href="example.html"><strong aria-hidden="true">3.</strong> Example</a></li><li class="chapter-item expanded "><a href="implementation.html" class="active"><strong aria-hidden="true">4.</strong> Implementation</a></li><li class="chapter-item expanded "><a href="todo.html"><strong aria-hidden="true">5.</strong> TODO</a></li><li class="chapter-item expanded "><a href="references.html"><strong aria-hidden="true">6.</strong> References</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                        
                    </div>

                    <h1 class="menu-title">Accountable Safety for GRANDPA</h1>

                    <div class="right-buttons">
                        
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        
                        
                        

                    </div>
                </div>

                
                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css" integrity="sha384-AfEj0r4/OFrOo5t7NnNe46zW/tFgW6x/bCJG8FqQCEo3+Aro6EYUG4+cU+KJWu/X" crossorigin="anonymous">
<h1 id="implementation"><a class="header" href="#implementation">Implementation</a></h1>
<p>The natural place to run the accountable safety protocol is on-chain. Only voters participate, since
they are guaranteed to be able to respond to all requests. Although anyone listening to the grandpa
protocol should in principle be able to take part.</p>
<h2 id="comparison-with-proof-of-concept"><a class="header" href="#comparison-with-proof-of-concept">Comparison with proof-of-concept</a></h2>
<p>In the proof-of-concept implementation we have the methods</p>
<pre><pre class="playground"><code class="language-rust">
<span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>fn start(
	block_not_included,
	Round_for_block_not_included,
	commit_for_block_not_included
)

// Ask the question why the estimate the previous round didn't include the earlier block
fn start_query_round(round, voters) -&gt; Query

fn add_response(round, voter, query_response) -&gt; Option&lt;NextQuery&gt;

// Ask what prevotes the voters know about
fn start_prevote_query(round, voters) -&gt; PrevoteQuery

fn add_prevote_response(round, voter, query_response) -&gt; Option&lt;NextQuery&gt;

fn equivocations_detected() -&gt; Vec&lt;EquivocationDetected&gt;
<span class="boring">}
</span></code></pre></pre>
<p>where</p>
<pre><pre class="playground"><code class="language-rust">
<span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>struct Query {
	pub round: RoundNumber,
	pub receivers: Vec&lt;VoterId&gt;,
	pub block_not_included: BlockNumber,
}

enum NextQuery {
	AskAboutRound(Query),
	PrevotesForRound(PrevoteQuery),
}
<span class="boring">}
</span></code></pre></pre>
<h2 id="outline"><a class="header" href="#outline">Outline</a></h2>
<p>We divide up the implementation into two main components.</p>
<ol>
<li>The runtime maintains the current state on-chain, which then exposes functions to initiate the
protocol, query the state, and submit replies to the questions asked by the protocol.</li>
<li>An accountable safety worker that listens to incoming blocks to detect mutually
inconsistent finalized blocks, and then calls into the runtime to start the protocol. It also
monitors the state of the protocol and submits replies when asked for.</li>
</ol>
<h3 id="input"><a class="header" href="#input">Input</a></h3>
<p>Like the equivocation reporting API for GRANDPA, the API here would use unsigned extrinsics. To
avoid spam we do like with equivocation reporting that only block authors can submit. The
alternative to using unsigned extrinsics would be to use signed extrinsics, but this would mean the
need to maintain funded accounts. This might deter reporting issues.</p>
<pre><pre class="playground"><code class="language-rust">
<span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>sp_api::decl_runtime_apis! {
	pub trait GrandpaApi {
		// Initiate the accountable safety protocol. We can have multiple concurrently
		// running sessions so we need an instance tag to separate them.
		// Note: there is an assumption here that `commit_for_new_block` is for a later
		// round than the other
		fn submit_start_accountable_safety_protocol_extrinsic(
			commit_for_new_block,
			commit_for_block_not_included,
		);

		// Each voter that are recipients for the queries add their responses.
		fn add_response(round, voter, query_response, instance);

		// Add response for when asked what prevotes seen.
		fn add_prevote_response(round, voter, query_response, instance);
	}
}
<span class="boring">}
</span></code></pre></pre>
<h3 id="output"><a class="header" href="#output">Output</a></h3>
<p>Nodes will track the state of the accountable safety protocol by calling into the runtime when
importing blocks. This is handled by a separate running worker, and not by the import pipeline.</p>
<pre><pre class="playground"><code class="language-rust">
<span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>sp_api::decl_runtime_apis! {
	pub trait GrandpaApi {
		// Currently running accountable safety instances.
		fn active_accountable_safety_instances() -&gt; Vec&lt;AccountableSafetyId&gt;;

		// Get the state of a running accountable instance
		fn acountable_safety_state(instance_id) -&gt; Option&lt;AccountableSafety&gt;;
	}
}
<span class="boring">}
</span></code></pre></pre>
<p>In particular, they would need to keep track of if their response is needed. If requested to do so,
nodes would then log their responses using <code>add_response</code> and <code>add_prevote_response</code>.</p>
<p><em>Note:</em> Instead of having to call into the runtime when importing blocks, an alternative would be to
use Digests. The downside of this is that it would be harder to deprecate, if necessary.</p>
<h2 id="storage"><a class="header" href="#storage">Storage</a></h2>
<p>The equivalent of <code>AccountableSafety</code> struct will be stored on-chain. In the proof-of-concept this
is</p>
<pre><pre class="playground"><code class="language-rust">
<span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>struct AccountableSafety {
	block_not_included: BlockNumber,
	round_for_block_not_included: RoundNumber,
	commit_for_block_not_included: Commit,
	querying_rounds: BTreeMap&lt;RoundNumber, QueryState&gt;,
	prevote_queries: BTreeMap&lt;RoundNumber, QueryState&gt;,
}

struct QueryState {
	round: RoundNumber,
	voters: Vec&lt;VoterId&gt;,
	responses: BTreeMap&lt;VoterId, QueryResponse&gt;,
	equivocations: Vec&lt;EquivocationDetected&gt;,
}

enum QueryResponse {
	Prevotes(Vec&lt;Prevote&gt;),
	Precommits(Vec&lt;Precommit&gt;),
}
<span class="boring">}
</span></code></pre></pre>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                        
                            <a rel="prev" href="example.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>
                        

                        
                            <a rel="next" href="todo.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>
                        

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                
                    <a rel="prev" href="example.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>
                

                
                    <a rel="next" href="todo.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
                
            </nav>

        </div>

        

        

        

        
        <script type="text/javascript">
            window.playground_copyable = true;
        </script>
        

        

        
        <script src="elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="searcher.js" type="text/javascript" charset="utf-8"></script>
        

        <script src="clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
        

        

    </body>
</html>
